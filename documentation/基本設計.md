# フロー
## main
動作主：RA
1. WorldStateを初期化して保持する．
1. 主たるコントラクトのバイトコードを受け取り，それをWorldStateに与えることでコントラクトアカウントを作成したのち，そのアドレスをprimary_contractsに追加する．
1. 従たるコントラクトのバイトコードを0以上受け取り，WorldStateに与えることでコントラクトアカウントを作成したのち，そのアドレスをsecondary_contractsに追加する．

1. VMを生成し保持する．このときWorldStateの参照を与える．

1. primary_contractsからコントラクトアカウントのアドレスを順番に取り出し以下のように命令を実行する。外部呼び出しされるコントラクトに対しても以下を行う．
    
    1. VMにコントラクトアカウントのアドレスを与え，{実行環境，機械状態，ニーモニックの集合，パス条件，分岐しない場合のジャンプ先，分岐した場合のジャンプ先， } in ブロック を初期化する．さらに以下を実行する．
        1. アドレスがprimary_contractsから取り出したものである場合，{エッジの集合，ノードの集合 } in CfgManager, call_stackを初期化する．
        1. 外部呼び出しである場合は，呼び出し元コントラクトで生成した実行環境と一部の機械状態を与え上書きする．
    
    1. 停止命令に到達するまで以下の命令の実行を繰り返す．実行中に外部呼び出しがあった場合は，その命令に従い呼び出し処理を行う．コントラクト生成があった場合は，そのバイトコードからアカウントを生成し，WorldStateに保存した後アドレスをprimary_contractsに追加する．
        1. プログラムカウンタ in 機械状態　が指すバイトコードを取得
        1. 命令を実行する．命令が引数をとる場合は，プログラムカウンタを進めてその値を取得する．call系やcreate系命令であればここで外部呼び出しを行う．
        1. プログラムカウンタを進め次の命令に合わせる．
         
         
         
  

# 分岐

## 分岐する場合
1. 現在の状態をCFGに保存
1. ジャンプ先pc、続行先pcを用意
1. ジャンプ先pcをセットして現在の状態をdfs用スタックにpush
1. 続行先pcをセットして実行


### ロールバック時
1. dfs用スタックから状態をpop
1. 実行

# createによって新たなコントラクトが生成される場合
## 戻り先の作成
1. 現在の状態をCFGに保存
1. 戻り先となるpcを用意
1. 現在の状態をreturn_destとして維持



# createの初期化コード実行時やcallにおいて外部ジャンプする際
## 戻り先の作成
1. 現在の状態をCFGに保存
1. 戻り先となるpcを用意
1. ~~現在の状態をreturn_destとして維持~~ ←　再びコールがあると上書きされる
1. 現在の状態をcall_stackにpush

## 外部コードの状態作成
1. 外部コントラクトの状態をセット
1. storage(, returndata)を空にする
1. 実行

## 外部から戻るとき(create以外)
1. 現在の状態をCFGに保存
1. call_stackの先頭の状態に現在のstack, memory(, returndata)をセット
1. call_stackからpopした状態を復元
1. 実行

## 外部から戻るとき(create時)
1. 現在の状態をCFGに保存
1. 現在のpcが参照している命令の次の番地~末端までを新しいコントラクトしてバイトコード群に追加
1. call_stackの先頭の状態に現在のstack, memory(, returndata)をセット
1. call_stackからpopした状態を復元
1. 実行


# delegatecallにおいて外部ジャンプする際のBasicBlockの扱い
## 戻り先の作成
上に同じ

## 外部コードの状態作成
1. 外部コントラクトの状態をセット
1. 実行

## 外部から戻るとき
1. 現在の状態をCFGに保存
1. call_stackの先頭の状態に現在のstorage, stack, memory(, returndata)をセット
1. call_stackからpopした状態を復元
1. 実行

# 終端到達時(return以外)
1. 現在の状態をCFGに保存
1. dfs用スタックが空でなければロールバック

